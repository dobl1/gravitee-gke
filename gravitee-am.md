# Deploy Gravitee Access Management to Google Kubernetes Engine (GKE)

## Add Helm repositories
```bash
export REPO_NAME_BITNAMI='bitnami' && \
export REPO_NAME_GRAVITEE='graviteeio' && \
helm repo add $REPO_NAME_BITNAMI https://charts.bitnami.com/bitnami && \
helm repo add $REPO_NAME_GRAVITEE https://helm.gravitee.io && \
helm repo update
```

## Kubernetes environment variables
```bash
export NAMESPACE='sandbox-graviteeio-am' && \
kubectl create namespace $NAMESPACE
```

## Mongo environment variables
```bash
export NAME_MONGO_AM='graviteeio-am3x-mongodb' && \
export MONGODB_USER='root' && \
export MONGODB_ROOT_PASSWORD='' # default value will be generated by mongo on installation
```

## Gravitee environment variables
```bash
export NAME_GRAVITEE_AM='graviteeio-am3x'
```

## Install MongoDB
```bash
helm install $NAME_MONGO_AM --namespace=$NAMESPACE $REPO_NAME_BITNAMI/mongodb
```

## Install Gravitee AM

```bash
export MONGODB_ROOT_PASSWORD=$(kubectl get secret --namespace $NAMESPACE $NAME_MONGO_AM -o jsonpath="{.data.mongodb-root-password}" | base64 --decode)
```

```bash
export GRAVITEE_HOST='am.sandbox-gravitee.example.com' # Replace by your host
```

> The following assumes you already deployed the Ngnix ingress and Cert Manager (part of APIm install)
> The external IP that is allocated to the ingress-controller is the IP to which all incoming traffic should be routed. To enable this, add it to a DNS zone you control. Details : https://cert-manager.io/docs/tutorials/acme/ingress/

```bash
# edit file and put your email, save and exit by doing "esc + :x)
kubectl create --edit -f https://cert-manager.io/docs/tutorials/acme/example/production-issuer.yaml -n $NAMESPACE
```

```bash
helm upgrade $NAME_GRAVITEE_AM \
    --namespace=$NAMESPACE \
    --set mongo.uri="mongodb://$MONGODB_USER:$MONGODB_ROOT_PASSWORD@$NAME_MONGO_AM.$NAMESPACE.svc.cluster.local:27017/admin?retryWrites=true&w=majority&connectTimeoutMS=30000&tls=false&ssl=false" \
    --set api.replicaCount=1 \
    --set gateway.replicaCount=1 \
    --set ui.replicaCount=1 \
    --set api.ingress.hosts={$GRAVITEE_HOST} \
    --set api.ingress.tls[0].hosts={$GRAVITEE_HOST} \
    --set api.ingress.tls[0].secretName=$GRAVITEE_HOST \
    --set gateway.ingress.hosts={auth.$GRAVITEE_HOST} \
    --set gateway.ingress.tls[0].hosts={auth.$GRAVITEE_HOST} \
    --set gateway.ingress.tls[0].secretName=auth.$GRAVITEE_HOST \
    --set gateway.ingress.annotations."kubernetes\.io\/app\-root"="/" \
    --set gateway.ingress.annotations."kubernetes\.io\/rewrite\-target"="/" \
    --set gateway.ingress.path="/" \
    --set ui.ingress.hosts={$GRAVITEE_HOST} \
    --set ui.ingress.tls[0].hosts={$GRAVITEE_HOST} \
    --set ui.ingress.tls[0].secretName=$GRAVITEE_HOST \
    --set ui.ingress.annotations."kubernetes\.io\/app\-root"="/" \
    --set ui.ingress.annotations."kubernetes\.io\/rewrite\-target"="/" \
    --set ui.ingress.path="/" \
    $REPO_NAME_GRAVITEE/am

    # --set ui.ingress.annotations."nginx\.ingress\.kubernetes\.io\/app\-root"="/console" \
    # --set ui.ingress.annotations."nginx\.ingress\.kubernetes\.io\/rewrite\-target"="/console" \

```

Update ingress to trigger tls certs generation
```bash
kubectl -n $NAMESPACE annotate ingress cert-manager.io/issuer="letsencrypt-prod" --all
```

## Backup mongo database (GCP Cloud Shell based)
```bash
export NAMESPACE='sandbox-graviteeio-am' && \
export NAME_MONGO_AM='graviteeio-am3x-mongodb'
export MONGODB_ROOT_PASSWORD=$(kubectl get secret --namespace $NAMESPACE $NAME_MONGO_AM -o jsonpath="{.data.mongodb-root-password}" | base64 --decode) && \
kubectl port-forward --namespace $NAMESPACE svc/$NAME_MONGO_AM 27017:27017 &

mkdir backup-$NAMESPACE-$NAME_MONGO_AM && \
chmod o+w backup-$NAMESPACE-$NAME_MONGO_AM && \
cd backup-$NAMESPACE-$NAME_MONGO_AM

docker run --rm --name mongodb -v $(pwd):/app --net="host" bitnami/mongodb:latest mongodump -u root -p $MONGODB_ROOT_PASSWORD -o /app

cd ..  && \
zip -r backup-$NAMESPACE-$NAME_MONGO_AM.zip backup-$NAMESPACE-$NAME_MONGO_AM && \
cloudshell download backup-$NAMESPACE-$NAME_MONGO_AM.zip
```

## Uninstall Gravitee AM
```bash
export NAME_GRAVITEE_AM='graviteeio-am3x' && \
export NAMESPACE='sandbox-graviteeio-am' && \
helm uninstall $NAME_GRAVITEE_AM --namespace=$NAMESPACE
```