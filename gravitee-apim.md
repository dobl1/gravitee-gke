# Deploy Gravitee API management platform to Google Kubernetes Engine (GKE)

## Add Helm repositories
```bash
export REPO_NAME_BITNAMI='bitnami' && \
export REPO_NAME_GRAVITEE='graviteeio' && \
export REPO_NAME_NGNIX='ingress-nginx' && \
export REPO_NAME_CERT_MANAGER='jetstack' && \
helm repo add $REPO_NAME_BITNAMI https://charts.bitnami.com/bitnami && \
helm repo add $REPO_NAME_GRAVITEE https://helm.gravitee.io && \
helm repo add $REPO_NAME_NGNIX https://kubernetes.github.io/ingress-nginx && \
helm repo add $REPO_NAME_CERT_MANAGER https://charts.jetstack.io && \
helm repo update
```

## Kubernetes environment variables
```bash
export NAMESPACE='sandbox-graviteeio' && \
kubectl create namespace $NAMESPACE
```

## Mongo environment variables
```bash
export NAME_MONGO_APIM='graviteeio-apim3x-mongodb' && \
export MONGODB_USER='root' && \
export MONGODB_ROOT_PASSWORD='' # default value will be generated by mongo on installation
```

## Gravitee environment variables
```bash
export NAME_GRAVITEE_APIM='graviteeio-apim3x'
```

## Install Ngnix ingress
```bash
helm install nginx-ingress $REPO_NAME_NGNIX/ingress-nginx --set rbac.create=true --set controller.publishService.enabled=true
```

## Install Cert Manager
```bash
helm install \
  cert-manager $REPO_NAME_CERT_MANAGER/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --version v1.5.3 \
  --set installCRDs=true
```

```bash
# edit file and put your email, save and exit by doing "esc + :x)
kubectl create --edit -f https://cert-manager.io/docs/tutorials/acme/example/production-issuer.yaml -n $NAMESPACE
```

## Install MongoDB
```bash
helm install $NAME_MONGO_APIM --namespace=$NAMESPACE $REPO_NAME_BITNAMI/mongodb
```

## Install Gravitee APIM

```bash
export MONGODB_ROOT_PASSWORD=$(kubectl get secret --namespace $NAMESPACE $NAME_MONGO_APIM -o jsonpath="{.data.mongodb-root-password}" | base64 --decode)
```

```bash
export GRAVITEE_HOST='apim.sandbox-gravitee.example.com' # Replace by your host
```

> The external IP that is allocated to the ingress-controller is the IP to which all incoming traffic should be routed. To enable this, add it to a DNS zone you control. Details : https://cert-manager.io/docs/tutorials/acme/ingress/

```bash
helm install $NAME_GRAVITEE_APIM \
    --namespace=$NAMESPACE \
    --set mongo.uri="mongodb://$MONGODB_USER:$MONGODB_ROOT_PASSWORD@$NAME_MONGO_APIM.$NAMESPACE.svc.cluster.local:27017/admin?retryWrites=true&w=majority&connectTimeoutMS=30000&tls=false&ssl=false" \
    --set api.replicaCount=1 \
    --set gateway.replicaCount=1 \
    --set ui.replicaCount=1 \
    --set elasticsearch.enabled=true \
    --set es.enabled=true \
    --set es.endpoints={http://$NAME_GRAVITEE_APIM-elasticsearch-client.$NAMESPACE.svc.cluster.local:9200} \
    --set es.security.enabled=true \
    --set es.security.username=es-user-example \
    --set es.security.password=some-generated-password \
    --set api.ingress.management.hosts={$GRAVITEE_HOST} \
    --set api.ingress.management.tls[0].hosts={$GRAVITEE_HOST} \
    --set api.ingress.management.tls[0].secretName=$GRAVITEE_HOST \
    --set api.ingress.portal.hosts={$GRAVITEE_HOST} \
    --set api.ingress.portal.tls[0].hosts={$GRAVITEE_HOST} \
    --set api.ingress.portal.tls[0].secretName=$GRAVITEE_HOST \
    --set gateway.ingress.hosts={$GRAVITEE_HOST} \
    --set gateway.ingress.tls[0].hosts={$GRAVITEE_HOST} \
    --set gateway.ingress.tls[0].secretName=$GRAVITEE_HOST \
    --set portal.ingress.hosts={$GRAVITEE_HOST} \
    --set portal.ingress.tls[0].hosts={$GRAVITEE_HOST} \
    --set portal.ingress.tls[0].secretName=$GRAVITEE_HOST \
    --set ui.ingress.hosts={$GRAVITEE_HOST} \
    --set ui.ingress.tls[0].hosts={$GRAVITEE_HOST} \
    --set ui.ingress.tls[0].secretName=$GRAVITEE_HOST \
    --set management.url=https://$GRAVITEE_HOST/console/ \
    $REPO_NAME_GRAVITEE/apim3
```

Update ingress to trigger tls certs generation
```bash
kubectl -n $NAMESPACE annotate ingress cert-manager.io/issuer="letsencrypt-prod" --all
```

```bash
kubectl get pods --namespace=$NAMESPACE -l app.kubernetes.io/instance=$NAME_GRAVITEE_APIM -w
```

## Backup mongo database (GCP Cloud Shell based)
```bash
export NAMESPACE='sandbox-graviteeio' && \
export NAME_MONGO_APIM='graviteeio-apim3x-mongodb' && \
export MONGODB_ROOT_PASSWORD=$(kubectl get secret --namespace $NAMESPACE $NAME_MONGO_APIM -o jsonpath="{.data.mongodb-root-password}" | base64 --decode) && \
kubectl port-forward --namespace $NAMESPACE svc/$NAME_MONGO_APIM 27017:27017 &

mkdir backup-$NAMESPACE-$NAME_MONGO_APIM && \
chmod o+w backup-$NAMESPACE-$NAME_MONGO_APIM && \
cd backup-$NAMESPACE-$NAME_MONGO_APIM

docker run --rm --name mongodb -v $(pwd):/app --net="host" bitnami/mongodb:latest mongodump -u root -p $MONGODB_ROOT_PASSWORD -o /app

cd ..  && \
zip -r backup-$NAMESPACE-$NAME_MONGO_APIM.zip backup-$NAMESPACE-$NAME_MONGO_APIM && \
cloudshell downloadbackup-$NAMESPACE-$NAME_MONGO_APIM.zip && \
```

## Uninstall Gravitee APIM
```bash
export NAME_GRAVITEE_APIM='graviteeio-apim3x' && \
export NAMESPACE='sandbox-graviteeio' && \
helm uninstall $NAME_GRAVITEE_APIM --namespace=$NAMESPACE
```